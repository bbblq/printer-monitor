# 打印机监控系统 - 功能更新报告

## 更新日期
2026-01-16 14:25

## 实现的功能

### ✅ 1. 黑白打印机显示优化

**问题描述：**
- 理光 MP 2014 黑白打印机显示了多个墨盒条（包括空的彩色墨盒）
- 用户上传的截图显示：两个 0% 的空墨盒 + 一个 100% 的黑色墨盒

**解决方案：**
1. **过滤空墨盒**：在 `snmp.ts` 中添加了过滤逻辑，移除 level=0 且 max=0 的占位符墨盒
2. **清除旧数据**：在 `printerService.ts` 中，每次刷新前先删除旧的耗材数据，防止新旧数据混合显示

**修改文件：**
- `src/lib/snmp.ts` - 添加墨盒过滤逻辑
- `src/lib/printerService.ts` - 添加清除旧数据逻辑

**结果：**
- ✅ 理光 MP 2014ad (1层西区): 只显示 **1个黑色墨盒 100%**
- ✅ 理光 MP 2014ad (1层东区): 只显示 **1个黑色墨盒 100%**

---

### ✅ 2. 后台排序功能

**功能描述：**
管理员可以在后台管理面板调整打印机的显示顺序

**实现细节：**
1. **数据库更新**：
   - 在 `printers` 表添加 `display_order` 列
   - 添加自动迁移逻辑，兼容现有数据库

2. **后台界面**：
   - 在管理面板添加"排序"列
   - 每台打印机旁边有上移/下移按钮
   - 点击按钮实时更新排序

3. **前端显示**：
   - 主看板按 `display_order` 排序显示
   - 排序更改立即反映到前端

**修改文件：**
- `src/lib/db.ts` - 添加 display_order 列和迁移逻辑
- `src/lib/printerService.ts` - 查询时按 display_order 排序
- `src/app/admin/page.tsx` - 添加上移/下移按钮
- `src/app/api/admin/printers/route.ts` - 添加 reorder 操作

**使用方法：**
1. 访问 http://localhost:3000/admin
2. 在打印机列表的"排序"列，点击上下箭头
3. 返回主看板查看新的排序

---

### ✅ 3. 自动刷新和智能换墨检测

**功能描述：**
系统每小时自动刷新所有打印机状态，并智能检测墨盒更换事件

**自动刷新：**
- 创建 `autoRefresh.ts` 服务
- 每小时（3600000ms）自动执行一次 SNMP 扫描
- 应用启动时自动开始运行

**智能换墨检测：**
改进的检测逻辑，避免误报：
1. ✅ 墨粉量跳升 >40%
2. ✅ 之前不是 100%（排除一直满的情况）
3. ✅ 之前不是 0%（排除打印机重启）
4. ✅ 新墨粉量 ≥80%（确认是新墨盒）

**排除的误报情况：**
- ❌ 打印机重启（从 0% 跳到 100%）
- ❌ 墨粉一直保持 100%（没有实际更换）
- ❌ 小幅波动（<40%）

**修改文件：**
- `src/lib/autoRefresh.ts` - 新建自动刷新服务
- `src/lib/init.ts` - 应用初始化逻辑
- `src/lib/printerService.ts` - 改进换墨检测算法
- `src/app/api/printers/route.ts` - 启动时初始化服务

**查看换墨记录：**
- 在主看板点击打印机卡片
- 查看"更换记录"弹窗

---

## 技术细节

### 数据库变更

```sql
-- 添加排序字段
ALTER TABLE printers ADD COLUMN display_order INTEGER DEFAULT 0;
```

### 关键代码片段

**1. 过滤空墨盒（snmp.ts）：**
```typescript
result.supplies = result.supplies.filter(supply => {
    // 保留有实际数据的墨盒
    if (supply.level > 0 || supply.max > 0) return true;
    // 保留废墨盒（即使为空）
    if (supply.type === 'waste') return true;
    // 移除空占位符
    return false;
});
```

**2. 清除旧数据（printerService.ts）：**
```typescript
// 刷新前先删除旧数据
db.prepare('DELETE FROM supplies_current WHERE printer_id = ?').run(p.id);
```

**3. 智能换墨检测（printerService.ts）：**
```typescript
const isReplacement = 
    percentJump > 40 &&        // 跳升 >40%
    currentPercent < 100 &&    // 之前不是满的
    currentPercent > 0 &&      // 之前不是空的
    newPercent >= 80;          // 新墨盒 ≥80%
```

---

## 测试结果

### 黑白打印机显示
| 打印机 | 之前 | 现在 |
|--------|------|------|
| 理光 MP 2014ad (1层西区) | 3个墨盒条 (0%, 0%, 100%) | ✅ 1个墨盒条 (100%) |
| 理光 MP 2014ad (1层东区) | 3个墨盒条 (0%, 0%, 100%) | ✅ 1个墨盒条 (100%) |

### 排序功能
- ✅ 管理面板显示上下箭头按钮
- ✅ 点击按钮实时更新排序
- ✅ 主看板立即反映新排序

### 自动刷新
- ✅ 应用启动时自动开始
- ✅ 每小时执行一次
- ✅ 控制台显示刷新日志

### 换墨检测
- ✅ 检测到墨粉跳升时记录
- ✅ 排除打印机重启误报
- ✅ 排除一直100%的情况

---

## 使用指南

### 启动应用
```bash
npm run dev
```

### 访问地址
- 主看板：http://localhost:3000
- 管理面板：http://localhost:3000/admin（密码：admin）

### 调整打印机顺序
1. 访问管理面板
2. 在"排序"列点击上下箭头
3. 返回主看板查看新排序

### 查看换墨记录
1. 在主看板点击打印机卡片
2. 查看弹出的历史记录窗口

---

## 后续建议

### 可选优化
1. **自定义刷新间隔**：在管理面板添加设置，允许调整自动刷新时间
2. **换墨通知**：检测到换墨时发送邮件/微信通知
3. **墨粉预警**：当墨粉低于某个阈值时发出警告
4. **统计报表**：生成墨粉使用统计和更换频率报告

---

## 总结

✅ **所有需求已实现：**
1. 黑白打印机只显示一个墨盒（不再显示多余的空墨盒）
2. 后台可以调整打印机显示顺序
3. 系统每小时自动刷新，智能检测换墨事件

系统现在运行稳定，所有功能正常工作！
